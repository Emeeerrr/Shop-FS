generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

enum TransactionStatus {
  PENDING
  APPROVED
  DECLINED
  ERROR
}

enum DeliveryStatus {
  PENDING
  READY
  FAILED
}

model Product {
  id String @id @default(uuid())
  name String
  description String
  priceCents Int
  currency String @default("COP")
  sku String @unique
  active Boolean @default(true)

  stock Stock?
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Stock {
  productId String @id
  unitsAvailable Int

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt
}

model Customer {
  id String @id @default(uuid())
  fullName String
  email String
  phone String

  deliveries Delivery[]
  transactions Transaction[]

  createdAt DateTime @default(now())
}

model Delivery {
  id String @id @default(uuid())
  customerId String

  addressLine1 String
  addressLine2 String?
  city String
  state String?
  postalCode String?
  notes String?

  feeCents Int
  status DeliveryStatus @default(PENDING)

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  createdAt DateTime @default(now())
}

model Transaction {
  id String @id @default(uuid())
  transactionNumber String @unique

  productId String
  customerId String
  deliveryId String?

  quantity Int

  amountProductCents Int
  amountBaseFeeCents Int
  amountDeliveryFeeCents Int
  amountTotalCents Int

  status TransactionStatus @default(PENDING)

  providerReference String?
  failureReason String?

  product Product @relation(fields: [productId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  delivery Delivery? @relation(fields: [deliveryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([productId])
}
